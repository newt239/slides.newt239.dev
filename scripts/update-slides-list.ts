import { promises as fs } from "fs";
import path from "path";

async function main() {
  const distDir = path.resolve(__dirname, "../dist/slides");
  const targetFile = path.resolve(__dirname, "../home/src/slides.ts");
  try {
    const entries: { id: string; title: string }[] = [];
    const items = await fs.readdir(distDir, { withFileTypes: true });
    for (const item of items) {
      if (item.isDirectory()) {
        const subdir = path.join(distDir, item.name);
        const files = await fs.readdir(subdir);
        if (files.some((f) => f.endsWith(".html"))) {
          const htmlFile = files.find((f) => f.endsWith(".html"))!;
          const htmlPath = path.join(subdir, htmlFile);
          const contentHtml = await fs.readFile(htmlPath, "utf-8");
          const match = /<title>([^<]+)<\/title>/.exec(contentHtml);
          const title = match ? match[1] : item.name;
          entries.push({ id: item.name, title });
        }
      }
    }
    const content = `// This file is auto-generated by scripts/update-slides-list.ts
export const slides = ${JSON.stringify(entries, null, 2)} as const
`;
    await fs.writeFile(targetFile, content, "utf-8");
  } catch (error) {
    console.error("Failed to update slides list:", error);
    process.exit(1);
  }
}

main();
